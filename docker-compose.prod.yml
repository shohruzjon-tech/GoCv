# Production: Everything runs in Docker with Traefik reverse proxy
# Usage: docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build
# Traefik must already be running on the cu24-network external network

services:
  # ---- MongoDB ----
  cv-mongo:
    image: mongo:8.0
    container_name: cv-mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-cvadmin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-cvpassword}
      MONGO_INITDB_DATABASE: cv-builder
    ports:
      - "127.0.0.1:4002:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - cv-internal
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---- Redis ----
  cv-redis:
    image: redis:7-alpine
    container_name: cv-redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redispassword}
    ports:
      - "127.0.0.1:4003:6379"
    volumes:
      - redis_data:/data
    networks:
      - cv-internal
    healthcheck:
      test:
        ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---- NestJS Backend ----
  cv-backend:
    build:
      context: .
      dockerfile: apps/cv-backend/Dockerfile
    container_name: cv-backend
    restart: always
    expose:
      - "4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      MONGODB_URI: mongodb://${MONGO_USERNAME:-cvadmin}:${MONGO_PASSWORD:-cvpassword}@mongo:27017/cv-builder?authSource=admin
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_DEFAULT_MODEL: ${OPENAI_DEFAULT_MODEL:-gpt-5}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_DEFAULT_MODEL: ${ANTHROPIC_DEFAULT_MODEL:-claude-sonnet-4-20250514}
      AI_PRIMARY_PROVIDER: ${AI_PRIMARY_PROVIDER:-openai}
      AI_FALLBACK_PROVIDER: ${AI_FALLBACK_PROVIDER:-anthropic}
      AI_FAILOVER_THRESHOLD: ${AI_FAILOVER_THRESHOLD:-3}
      AI_AB_TESTING_ENABLED: ${AI_AB_TESTING_ENABLED:-false}
      AI_COST_OPTIMIZATION: ${AI_COST_OPTIMIZATION:-false}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_PREMIUM_MONTHLY: ${STRIPE_PRICE_PREMIUM_MONTHLY:-}
      STRIPE_PRICE_PREMIUM_YEARLY: ${STRIPE_PRICE_PREMIUM_YEARLY:-}
      STRIPE_PRICE_ENTERPRISE_MONTHLY: ${STRIPE_PRICE_ENTERPRISE_MONTHLY:-}
      STRIPE_PRICE_ENTERPRISE_YEARLY: ${STRIPE_PRICE_ENTERPRISE_YEARLY:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-cv-builder-uploads}
      FRONTEND_URL: ${FRONTEND_URL:-https://gocv.live}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@cvbuilder.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.cv-backend.rule=Host(`api.gocv.live`)"
      - "traefik.http.routers.cv-backend.entrypoints=websecure"
      - "traefik.http.routers.cv-backend.tls=true"
      - "traefik.http.routers.cv-backend.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.cv-backend.loadbalancer.server.port=4000"
      # CORS headers middleware
      - "traefik.http.middlewares.cv-backend-headers.headers.accesscontrolalloworiginlist=https://gocv.live"
      - "traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
      - "traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowheaders=Content-Type,Authorization"
      - "traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowcredentials=true"
      - "traefik.http.routers.cv-backend.middlewares=cv-backend-headers"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:4000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cv-internal
      - cu24-network

  # ---- Next.js Frontend ----
  cv-web:
    build:
      context: .
      dockerfile: apps/cv-web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.gocv.live}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-wss://api.gocv.live}
    container_name: cv-frontend
    restart: always
    expose:
      - "3002"
    environment:
      NODE_ENV: production
      PORT: 3002
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.cv-frontend.rule=Host(`gocv.live`)"
      - "traefik.http.routers.cv-frontend.entrypoints=websecure"
      - "traefik.http.routers.cv-frontend.tls=true"
      - "traefik.http.routers.cv-frontend.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.cv-frontend.loadbalancer.server.port=3002"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3002/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - cu24-network

volumes:
  mongo_data:
  redis_data:

networks:
  cv-internal:
    driver: bridge
  cu24-network:
    external: true
