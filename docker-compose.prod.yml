# Production: Everything runs in Docker
# Usage: docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

services:
  # ---- MongoDB ----
  mongo:
    image: mongo:7
    container_name: cv-mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-cvadmin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-cvpassword}
      MONGO_INITDB_DATABASE: cv-builder
    volumes:
      - mongo_data:/data/db
    networks:
      - cv-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---- Redis ----
  redis:
    image: redis:7-alpine
    container_name: cv-redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redispassword}
    volumes:
      - redis_data:/data
    networks:
      - cv-network
    healthcheck:
      test:
        ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---- NestJS Backend ----
  backend:
    build:
      context: .
      dockerfile: apps/cv-backend/Dockerfile
    container_name: cv-backend
    restart: always
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      MONGODB_URI: mongodb://${MONGO_USERNAME:-cvadmin}:${MONGO_PASSWORD:-cvpassword}@mongo:27017/cv-builder?authSource=admin
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-cv-builder-uploads}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@cvbuilder.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cv-network

  # ---- Next.js Frontend ----
  frontend:
    build:
      context: .
      dockerfile: apps/cv-web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000}
    container_name: cv-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
    depends_on:
      - backend
    networks:
      - cv-network

volumes:
  mongo_data:
  redis_data:

networks:
  cv-network:
    driver: bridge
