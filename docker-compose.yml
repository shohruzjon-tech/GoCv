# Production: GoCV services behind cu24 Traefik reverse proxy
# Usage: docker compose --env-file .env.prod up -d --build
#
# Traefik is managed by the cu24 compose stack and joins cv-network (external).
# ACME: TLS-ALPN-01 challenge (certresolver=letsencrypt) — NOT HTTP-01.
# HTTP→HTTPS redirect is handled globally by Traefik's entrypoint config.
# Domains: gocv.live (frontend), api.gocv.live (backend)
#
# ⚠ Cloudflare DNS: gocv.live & api.gocv.live MUST be DNS-only (gray cloud)
#   so Let's Encrypt TLS-ALPN-01 challenge can reach Traefik directly.

services:
  # ── MongoDB ───────────────────────────────────────────────
  gocv-mongo:
    image: mongo:8.0
    container_name: cv-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-cvadmin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-cvpassword}
      MONGO_INITDB_DATABASE: cv-builder
    ports:
      - "${MONGO_PORT:-4002}:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - cv-internal
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ── Redis ─────────────────────────────────────────────────
  gocv-redis:
    image: redis:7-alpine
    container_name: cv-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redispassword} --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - cv-internal
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── NestJS Backend (HTTP + WebSocket) ─────────────────────
  gocv-backend:
    build:
      context: .
      dockerfile: apps/cv-backend/Dockerfile
      args:
        NODE_ENV: production
    container_name: cv-backend
    restart: unless-stopped
    expose:
      - "4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      MONGODB_URI: mongodb://${MONGO_USERNAME:-cvadmin}:${MONGO_PASSWORD:-cvpassword}@gocv-mongo:27017/cv-builder?authSource=admin
      REDIS_HOST: gocv-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_DEFAULT_MODEL: ${OPENAI_DEFAULT_MODEL:-gpt-5}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_DEFAULT_MODEL: ${ANTHROPIC_DEFAULT_MODEL:-claude-sonnet-4-20250514}
      AI_PRIMARY_PROVIDER: ${AI_PRIMARY_PROVIDER:-openai}
      AI_FALLBACK_PROVIDER: ${AI_FALLBACK_PROVIDER:-anthropic}
      AI_FAILOVER_THRESHOLD: ${AI_FAILOVER_THRESHOLD:-3}
      AI_AB_TESTING_ENABLED: ${AI_AB_TESTING_ENABLED:-false}
      AI_COST_OPTIMIZATION: ${AI_COST_OPTIMIZATION:-false}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-cv-builder-uploads}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@gocv.live}
      FRONTEND_URL: ${FRONTEND_URL:-https://gocv.live}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@cvbuilder.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    labels:
      - traefik.enable=true
      - traefik.docker.network=cv-network
      # ── HTTPS router ──
      - traefik.http.routers.cv-backend.rule=Host(`${API_HOST:-api.gocv.live}`)
      - traefik.http.routers.cv-backend.entrypoints=websecure
      - traefik.http.routers.cv-backend.tls=true
      - traefik.http.routers.cv-backend.tls.certresolver=letsencrypt
      - traefik.http.routers.cv-backend.priority=10
      - traefik.http.routers.cv-backend.service=cv-backend
      # ── Service ──
      - traefik.http.services.cv-backend.loadbalancer.server.port=4000
      - traefik.http.services.cv-backend.loadbalancer.server.scheme=http
      # ── WebSocket support (Socket.IO) ──
      - traefik.http.services.cv-backend.loadbalancer.sticky.cookie=true
      - traefik.http.services.cv-backend.loadbalancer.sticky.cookie.name=cv_backend_id
      - traefik.http.services.cv-backend.loadbalancer.sticky.cookie.httponly=true
      # ── CORS headers middleware ──
      - traefik.http.middlewares.cv-backend-headers.headers.accesscontrolalloworiginlist=https://${WEB_HOST:-gocv.live}
      - traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS
      - traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowheaders=Content-Type,Authorization
      - traefik.http.middlewares.cv-backend-headers.headers.accesscontrolallowcredentials=true
      - traefik.http.routers.cv-backend.middlewares=cv-backend-headers
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "const http=require(''http'');const r=http.get(''http://localhost:4000/api'',res=>{process.exit(res.statusCode<500?0:1)});r.on(''error'',()=>process.exit(1));r.setTimeout(5000,()=>{r.destroy();process.exit(1)})"',
        ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      gocv-mongo:
        condition: service_healthy
      gocv-redis:
        condition: service_healthy
    networks:
      - cv-internal
      - cv-network

  # ── Next.js Frontend ──────────────────────────────────────
  gocv-frontend:
    build:
      context: .
      dockerfile: apps/cv-web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.gocv.live}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-wss://api.gocv.live}
    container_name: cv-frontend
    restart: unless-stopped
    expose:
      - "3002"
    environment:
      NODE_ENV: production
      PORT: 3002
    labels:
      - traefik.enable=true
      - traefik.docker.network=cv-network
      # ── HTTPS router ──
      - traefik.http.routers.cv-frontend.rule=Host(`${WEB_HOST:-gocv.live}`)
      - traefik.http.routers.cv-frontend.entrypoints=websecure
      - traefik.http.routers.cv-frontend.tls=true
      - traefik.http.routers.cv-frontend.tls.certresolver=letsencrypt
      - traefik.http.routers.cv-frontend.service=cv-frontend
      # ── Service ──
      - traefik.http.services.cv-frontend.loadbalancer.server.port=3002
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3002/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      gocv-backend:
        condition: service_healthy
    networks:
      - cv-network

volumes:
  mongo_data:
    driver: local
  redis_data:
    driver: local

networks:
  cv-internal:
    driver: bridge
  cv-network:
    external: true
    name: cv-network
